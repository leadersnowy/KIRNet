import pandas as pd
import numpy as np
import re
import warnings
warnings.filterwarnings("ignore")

# ==================== 配置 ====================

file_path = "../Data/血管代谢数据集（51例患者）.xlsx"
output_path = "../Data/补全后_血管代谢数据集.xlsx"

indicators = [
    "BMI","收缩压","舒张压","葡萄糖","胆固醇","低密度脂蛋白胆固醇","甘油三酯",
    "高密度脂蛋白胆固醇","D-二聚体","血小板","中性粒细胞","淋巴细胞",
    "NLR（中性粒细胞/淋巴细胞）","神经元特异性烯醇化酶","鳞状细胞癌相关抗原",
    "胃泌素释放肽前体","细胞角蛋白19片段","CRP","降钙素原","IL-6","BNP",
    "高敏肌钙蛋白T","肾小球滤过率","肌酐","脂蛋白a",
    "游离三碘甲状腺原氨酸","促甲状腺激素","游离甲状腺素"
]

extended_ranges = {
    'BMI': (14, 30), '收缩压': (90, 180), '舒张压': (60, 110), '葡萄糖': (3, 10),
    '胆固醇': (1, 7), '低密度脂蛋白胆固醇': (1, 4.5), '甘油三酯': (0.2, 3),
    '高密度脂蛋白胆固醇': (0.5, 2.5), 'D-二聚体': (0, 5000), '血小板': (20, 500),
    '中性粒细胞': (0.5, 10), '淋巴细胞': (0.5, 5), 'CRP': (0, 100), 'IL-6': (0, 50),
    'BNP': (0, 500), '高敏肌钙蛋白T': (0, 0.1), '肾小球滤过率': (30, 150),
    '肌酐': (40, 200), '脂蛋白a': (0, 1000)
}
normal_ranges = {
    'BMI': (18.5, 24.0),
    "收缩压": (90, 139),
    "舒张压": (60, 89),
    '葡萄糖': (3.9, 6.16),
    '胆固醇': (2.32, 5.62),
    '低密度脂蛋白胆固醇': (1.9, 3.12),
    '甘油三酯': (0.3, 1.92),
    '高密度脂蛋白胆固醇': (0.8, 1.8),
    'D-二聚体': (0, 500),
    '血小板': (125, 320),
    '神经元特异性烯醇化酶': (0, 17),
    '鳞状细胞癌相关抗原': (0, 2.5),
    '胃泌素释放肽前体': (0, 63),
    '细胞角蛋白19片段': (0, 3.3),
    'CRP': (0, 5),
    '降钙素原': (0, 0.05),
    'IL-6': (0, 7),
    'BNP': (0, 125),
    '高敏肌钙蛋白T': (0, 0.014),
    '肾小球滤过率': (60, 120),
    '肌酐': (57, 111),
    '脂蛋白a': (0, 300),
    '游离三碘甲状腺原氨酸': (3.1, 6.8),
    '促甲状腺激素': (0.75, 5.6),
    '游离甲状腺素': (12.8, 21.3),
    '中性粒细胞': (1.8, 6.3),
    '淋巴细胞': (1.1, 3.2),
    'NLR（中性粒细胞/淋巴细胞）': (1, 3)
}

# ==================== 药物偏置 ====================
drug_biases = { '八宝丹胶囊': {}, '乌苯美司片': {'淋巴细胞': 0.1, '中性粒细胞': 0.1}, '云南白药胶囊': {'CRP': -0.1, 'IL-6': -0.1}, '乙醇化重组人粒细胞刺激因子注射液': {'中性粒细胞': 0.4}, '参一胶囊': {'淋巴细胞': 0.1}, '参芪十一味颗粒': {'中性粒细胞': 0.1, '血小板': 0.1}, '参松养心胶囊': {}, '胞磷胆碱钠胶囊': {}, '利可君片': {'血小板': 0.2}, '卡泊三醇软膏': {}, '双歧杆菌三联活菌胶囊': {}, '地塞米松磷酸钠注射液': {'CRP': 0.3, 'IL-6': 0.3}, '地榆升白片': {'血小板': 0.2}, '头孢克污片': {}, '头孢地尼胶囊': {}, '多糖铁复合物胶囊': {}, '左匹克隆片': {}, '贞芪扶正颗粒': {'中性粒细胞': 0.2, '淋巴细胞': 0.2}, '贞芪扶正胶囊': {'中性粒细胞': 0.2, '淋巴细胞': 0.2}, '琥珀酸美托洛尔缓释片': {'血压': -0.1}, '甘草酸二铵肠溶胶囊': {'CRP': -0.2, 'IL-6': -0.2}, '甲泼尼龙片': {'CRP': 0.2}, '甲硫咪唑片': {'促甲状腺激素': -0.2}, '甲磺酸倍他司汀片': {}, '甲钴胺片': {}, '益血生胶囊': {'血小板': 0.1, '中性粒细胞': 0.1}, '盐酸二甲双胍缓释片': {'葡萄糖': -0.2}, '盐酸昂丹司琼片': {}, '盐酸格拉司琼片': {}, '盐酸氨溴索片': {}, '盐酸莫西沙星片': {}, '瑞舒伐他汀钙片': {'胆固醇': -0.2}, '聚二乙醇化重组人粒细胞刺激因子注射液': {'中性粒细胞': 0.4}, '聚乙二醇化重组人粒细胞刺激因子注射液': {'中性粒细胞': 0.4}, '糠酸莫米松乳膏': {}, '复方甲氧那明胶囊': {}, '复方皂矾丸': {'血小板': 0.1}, '复方甘草口服溶液': {'CRP': -0.1}, '螺内酯片': {'血压': -0.1}, '达格列净片': {'葡萄糖': -0.2}, '谷胱甘肽': {'CRP': -0.1, 'IL-6': -0.1}, '谷胱甘肽片': {'CRP': -0.1, 'IL-6': -0.1}, '连花清瘟颗粒': {'CRP': -0.1, 'IL-6': -0.1}, '呋塞米片': {'血压': -0.1}, '氨酚双氢可待因片': {}, '青地合剂': {}, '鸦胆子油软胶囊': {'中性粒细胞': -0.1, '血小板': -0.1}, '升血小板胶囊': {'血小板': 0.2}, '生血宝合剂': {'血小板': 0.2, '中性粒细胞': 0.1}, '固元颗粒': {}, '格列齐特缓释片': {'葡萄糖': -0.2}, '注射用人白介素-11': {'血小板': 0.4}, '注射用唑来膦酸': {'肌酐': 0.1}, '注射用香菇多糖': {'淋巴细胞': 0.2, '中性粒细胞': 0.2}, '醋酸地塞米松片': {'CRP': 0.2, 'IL-6': 0.2}, '重组人粒细胞刺激因子注射液': {'中性粒细胞': 0.4}, '香菇多糖注射液': {'淋巴细胞': 0.2, '中性粒细胞': 0.2}, '缬沙坦氢氯噻嗪': {'血压': -0.1}, '替吉奥胶囊': {'中性粒细胞': -0.2, '淋巴细胞': -0.2, '血小板': -0.1}, '注射用胸腺法新': {'淋巴细胞': 0.2} }

# ==================== 治疗偏置 ====================
treatment_biases = {
    '化疗': {'中性粒细胞': -0.3, '淋巴细胞': -0.3, '血小板': -0.2, 'CRP': 0.2, 'IL-6': 0.2, '肌酐': 0.1, '促甲状腺激素': 0.1},
    '放疗': {'CRP': 0.2, 'IL-6': 0.2, '中性粒细胞': -0.1},
    '手术治疗': {'CRP': 0.3, 'IL-6': 0.3},
    '免疫治疗': {'IL-6': 0.1, 'CRP': 0.1, '促甲状腺激素': 0.2, '游离甲状腺素': -0.1},
    '靶向治疗': {'收缩压': 0.1, '舒张压': 0.1, '肌酐': 0.1, '胆固醇': 0.1, '甘油三酯': 0.1}
}

# treatment_biases = {
#     '化疗': {
#         'BMI': -0.75,
#         '收缩压': 0.5,
#         '舒张压': 0.5,
#         '葡萄糖': 0.5,
#         '胆固醇': 0.5,
#         '低密度脂蛋白胆固醇': 0.5,
#         '甘油三酯': 0.5,
#         '高密度脂蛋白胆固醇': -0.25,
#         'D-二聚体': 0.0,
#         '血小板': -1.25,
#         '中性粒细胞': -1.25,
#         '淋巴细胞': -1.25,
#         'NLR（中性粒细胞/淋巴细胞）': 1.0,
#         '神经元特异性烯醇化酶': 0.25,
#         '鳞状细胞癌相关抗原': 0.0,
#         '胃泌素释放肽前体': 0.0,
#         '细胞角蛋白19片段': 0.0,
#         'CRP': 1.0,
#         '降钙素原': 0.5,
#         'IL-6': 1.0,
#         'BNP': 0.75,
#         '高敏肌钙蛋白T': 0.75,
#         '肾小球滤过率': -0.75,
#         '肌酐': 0.75,
#         '脂蛋白a': 0.5,
#         '游离三碘甲状腺原氨酸': -0.25,
#         '促甲状腺激素': 0.25,
#         '游离甲状腺素': 0.25
#     },
#     '放疗': {
#         'BMI': -0.5,
#         '收缩压': 0.25,
#         '舒张压': 0.25,
#         '葡萄糖': 0.0,
#         '胆固醇': -0.5,
#         '低密度脂蛋白胆固醇': -0.5,
#         '甘油三酯': 0.0,
#         '高密度脂蛋白胆固醇': -0.25,
#         'D-二聚体': -0.25,
#         '血小板': -0.5,
#         '中性粒细胞': -0.5,
#         '淋巴细胞': -1.25,
#         'NLR（中性粒细胞/淋巴细胞）': 1.0,
#         '神经元特异性烯醇化酶': 0.0,
#         '鳞状细胞癌相关抗原': 0.0,
#         '胃泌素释放肽前体': 0.0,
#         '细胞角蛋白19片段': 0.0,
#         'CRP': 0.75,
#         '降钙素原': 0.25,
#         'IL-6': 0.75,
#         'BNP': 0.25,
#         '高敏肌钙蛋白T': 0.25,
#         '肾小球滤过率': -0.5,
#         '肌酐': 0.5,
#         '脂蛋白a': 0.0,
#         '游离三碘甲状腺原氨酸': -0.5,
#         '促甲状腺激素': -0.5,
#         '游离甲状腺素': -0.5
#     },
#     '手术治疗': {
#         'BMI': -0.5,
#         '收缩压': 0.75,
#         '舒张压': 0.75,
#         '葡萄糖': 0.5,
#         '胆固醇': 0.0,
#         '低密度脂蛋白胆固醇': 0.0,
#         '甘油三酯': 0.0,
#         '高密度脂蛋白胆固醇': 0.0,
#         'D-二聚体': 0.75,
#         '血小板': -0.5,
#         '中性粒细胞': 1.0,
#         '淋巴细胞': -0.5,
#         'NLR（中性粒细胞/淋巴细胞）': 0.75,
#         '神经元特异性烯醇化酶': 0.0,
#         '鳞状细胞癌相关抗原': 0.0,
#         '胃泌素释放肽前体': 0.0,
#         '细胞角蛋白19片段': 0.0,
#         'CRP': 1.0,
#         '降钙素原': 0.5,
#         'IL-6': 0.75,
#         'BNP': 0.25,
#         '高敏肌钙蛋白T': 0.25,
#         '肾小球滤过率': -0.25,
#         '肌酐': 0.25,
#         '脂蛋白a': 0.0,
#         '游离三碘甲状腺原氨酸': -0.25,
#         '促甲状腺激素': 0.0,
#         '游离甲状腺素': 0.0
#     },
#     '免疫治疗': {
#         'BMI': -0.25,
#         '收缩压': 0.0,
#         '舒张压': 0.0,
#         '葡萄糖': 0.5,
#         '胆固醇': 0.5,
#         '低密度脂蛋白胆固醇': 0.5,
#         '甘油三酯': 0.5,
#         '高密度脂蛋白胆固醇': 0.0,
#         'D-二聚体': 0.0,
#         '血小板': -0.5,
#         '中性粒细胞': 0.5,
#         '淋巴细胞': 0.5,
#         'NLR（中性粒细胞/淋巴细胞）': 0.25,
#         '神经元特异性烯醇化酶': 0.25,
#         '鳞状细胞癌相关抗原': 0.0,
#         '胃泌素释放肽前体': 0.0,
#         '细胞角蛋白19片段': 0.0,
#         'CRP': 0.5,
#         '降钙素原': 0.5,
#         'IL-6': 1.0,
#         'BNP': 0.25,
#         '高敏肌钙蛋白T': 0.75,
#         '肾小球滤过率': -0.5,
#         '肌酐': 0.5,
#         '脂蛋白a': 0.5,
#         '游离三碘甲状腺原氨酸': -0.25,
#         '促甲状腺激素': 0.5,
#         '游离甲状腺素': -0.25
#     },
#     '靶向治疗': {
#         'BMI': 0.0,
#         '收缩压': 1.0,
#         '舒张压': 1.0,
#         '葡萄糖': 0.25,
#         '胆固醇': 0.75,
#         '低密度脂蛋白胆固醇': 0.75,
#         '甘油三酯': 0.5,
#         '高密度脂蛋白胆固醇': 0.0,
#         'D-二聚体': -0.25,
#         '血小板': -0.25,
#         '中性粒细胞': -0.25,
#         '淋巴细胞': -0.25,
#         'NLR（中性粒细胞/淋巴细胞）': 0.75,
#         '神经元特异性烯醇化酶': 0.0,
#         '鳞状细胞癌相关抗原': 0.0,
#         '胃泌素释放肽前体': 0.0,
#         '细胞角蛋白19片段': 0.0,
#         'CRP': 0.5,
#         '降钙素原': 0.25,
#         'IL-6': 0.5,
#         'BNP': 0.5,
#         '高敏肌钙蛋白T': 0.5,
#         '肾小球滤过率': -0.75,
#         '肌酐': 0.75,
#         '脂蛋白a': 0.25,
#         '游离三碘甲状腺原氨酸': -0.5,
#         '促甲状腺激素': -0.5,
#         '游离甲状腺素': -0.5
#     }
# }
# treat_effect = [
#             [-1.0, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, -0.5, 1.0, -1.5, -1.0, -1.0, 1.0, 0.5, 0, 0, 0, 1.5, 1.0, 1.5, 1.5,1.5, -1.0, 1.0, 0.5, 0, 0, 0],  # 化疗
#             [-0.5, 0.5, 0.5, 0, -0.5, -0.5, 0.5, -0.5, 0.5, -0.5, 0.5, -1.0, 1.0, 0, 0, 0, 0, 1.0, 0.5, 1.0, 0.5, 0.5,-0.5, 0.5, 0, -0.5, 0.5, -0.5],  # 放疗
#             [-0.5, 1.0, 1.0, 0.5, 0, 0, 0, 0, 1.0, -0.5, 0.5, -0.5, 0.5, 0, 0, 0, 0, 1.5, 0.5, 1.0, 0.5, 0.5, -0.5, 0.5,0, 0, 0, 0],  # 手术治疗
#             [-0.5, 0.5, 0.5, 1.0, 0.5, 0.5, 0.5, -0.5, 1.0, -1.0, 0.5, 0.5, 1.0, 0.5, 0, 0, 0, 1.5, 1.0, 1.5, 1.0, 1.5,-0.5, 0.5, 0.5, -0.5, 1.0, -0.5],  # 免疫治疗
#             [0, 1.5, 1.5, 0.5, 1.0, 1.0, 0.5, -0.5, 0.5, -0.5, -0.5, -0.5, 1.0, 0, 0, 0, 0, 1.0, 0.5, 1.0, 1.0, 1.0,-1.0, 1.0, 0.5, -1.0, 0.5, -1.0]  # 靶向治疗
#         ]
# treat_effect_expert = [
#             [-0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.0, -1.0, -1.0, -1.5, -1.5, 1.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5,0.0, 0.0, -0.5, 0.5, 0.5, -0.5, 0.5, 0.5],  # 化疗
#             [-0.5, 0.0, 0.0, 0.0, -0.5, -0.5, -0.5, 0.0, -1.0, -0.5, -1.5, -1.5, 1.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.0, 0.0, -0.5, 0.5, 0.0, -0.5, 0.5, -0.5],  # 放疗
#             [-0.5, 0.5, 0.5, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, -0.5, 1.5, -0.5, 1.0, 0.0, 0.0, 0.0, 0.0, 0.5, 0.5, 0.5, 0.0,0.0, 0.0, 0.0, 0.0, -0.5, 0.0, 0.0],  # 手术治疗
#             [0.0, -0.5, -0.5, 0.0, 0.5, 0.5, 0.5, 0.5, -1.0, 0.0, 0.5, 0.5, -0.5, 0.0, 0.0, 0.0, 0.0, -0.5, 0.0, 0.5,-0.5, 0.0, -0.5, 0.5, 0.5, 0.0, 0.0, 0.0],  # 免疫治疗
#             [0.0, 0.5, 0.5, 0.0, 0.5, 0.5, 0.5, 0.5, -1.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,0.0, -0.5, 0.5, 0.0, 0.0, 0.0, 0.0]  # 靶向治疗
#         ]

# ==================== 工具函数 ====================

def find_row_map(df):
    return {str(row.iloc[0]).strip(): i for i, row in df.iterrows()}

def is_missing(x):
    return pd.isna(x) or str(x).strip() in ["", "nan", "NA", "未测"]

import re

def get_drugs_at_time(df, row_map, col):
    drugs = []
    r = row_map.get("常规用药（西/中药）")
    if r is None:
        return drugs

    cell = str(df.iat[r, col])
    # 拆分成每个药物项
    items = re.split(r'\+|，|;', cell)  # 支持 + 、 ; 分隔符
    for item in items:
        # 提取括号前的药名
        match = re.match(r'([^(（]+)', item.strip())
        if match:
            drug_name = match.group(1).strip()
            if drug_name in drug_biases:
                drugs.append(drug_name)
    return drugs


def get_treatments_at_time(df, row_map, col):
    ts = []
    for t in treatment_biases:
        r = row_map.get(t)
        if r is not None and not is_missing(df.iat[r, col]):
            ts.append(t)
    return ts

def get_baseline(df, row_map, ind):
    r = row_map.get(ind)
    if r is None:
        return None
    vals = pd.to_numeric(df.iloc[r, 1:], errors="coerce")
    vals = vals.dropna()
    return vals.iloc[0] if len(vals) > 0 else None

# ==================== 主流程 ====================

sheets = pd.read_excel(file_path, sheet_name=None, header=None)

with pd.ExcelWriter(output_path, engine="openpyxl") as writer:

    for name, df in sheets.items():

        if "治疗中" not in str(name):
            df.to_excel(writer, sheet_name=name, index=False, header=False)
            continue

        row_map = find_row_map(df)
        time_cols = list(range(1, df.shape[1]))

        for ind in indicators:
            r = row_map.get(ind)
            if r is None:
                continue

            # 获取基线值
            baseline = get_baseline(df, row_map, ind)
            if baseline is None and ind in normal_ranges:
                lo, hi = normal_ranges[ind]
                baseline = (lo + hi) / 2
            baseline = float(baseline)  # 强制 float

            for i, c in enumerate(time_cols):
                # 上一时间点的值
                if i == 0:
                    prev_val = baseline
                else:
                    prev_val = df.iat[r, time_cols[i - 1]]
                    try:
                        prev_val = float(prev_val)
                    except (ValueError, TypeError):
                        prev_val = baseline

                # 当前时间点缺失值先填充
                cur_val = df.iat[r, c]
                if is_missing(cur_val):
                    cur_val = prev_val
                try:
                    cur_val = float(cur_val)
                except (ValueError, TypeError):
                    cur_val = prev_val

                # ------------------ 药物作用 ------------------
                delta_drug = 0.0
                for d in get_drugs_at_time(df, row_map, c):
                    if ind in drug_biases[d]:  # 只在映射表中存在指标才加偏置
                        delta_drug += drug_biases[d][ind]

                cur_val = cur_val * (1 + delta_drug)

                # ------------------ 治疗作用在下一时间点 ------------------
                if i < len(time_cols) - 1:
                    next_c = time_cols[i + 1]
                    next_val = df.iat[r, next_c]
                    if is_missing(next_val):
                        next_val = cur_val  # 用当前值填充
                    try:
                        next_val = float(next_val)
                    except (ValueError, TypeError):
                        next_val = cur_val

                    delta_treatment = 0.0
                    for t in get_treatments_at_time(df, row_map, c):
                        if ind in treatment_biases.get(t, {}):
                            delta_treatment += treatment_biases[t][ind]

                    next_val = next_val * (1 + delta_treatment)
                    df.iat[r, next_c] = round(next_val, 4)

                # ------------------ 限制指标范围 ------------------
                if ind in extended_ranges:
                    lo, hi = extended_ranges[ind]
                    cur_val = min(max(cur_val, lo), hi)

                df.iat[r, c] = round(cur_val, 4)

        # 强制 NLR 一致
        if "中性粒细胞" in row_map and "淋巴细胞" in row_map:
            r_n = row_map["中性粒细胞"]
            r_l = row_map["淋巴细胞"]
            r_nlr = row_map.get("NLR（中性粒细胞/淋巴细胞）")
            if r_nlr is not None:
                for c in time_cols:
                    n = df.iat[r_n, c]
                    l = df.iat[r_l, c]
                    if not is_missing(n) and not is_missing(l) and float(l) != 0:
                        df.iat[r_nlr, c] = round(float(n) / float(l), 4)

        df.to_excel(writer, sheet_name=name, index=False, header=False)

print("✅ 所有治疗中 sheet 已完成补全，且无生理指标缺失")
